//@version=5
strategy('Test V3 Tl ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
     overlay=true,
     initial_capital=10,
     default_qty_type=strategy.cash,
     default_qty_value=10,
     commission_type=strategy.commission.percent,
     commission_value=0.1)

// ====== ENHANCED VERSION with Market Regime Detection ======
// ====== Auto-detects: Uptrend, Downtrend, Sideways ======
// ====== Adapts strategy parameters based on market condition ======

// =====================================================================================================
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MARKET REGIME DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================================================
grpRegime = "Market Regime Detection"
useRegimeDetection = input.bool(true, "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î", group=grpRegime,
     tooltip="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå")

// ADX Settings
adxLength = input.int(14, "ADX Length", minval=1, group=grpRegime)
adxThreshold = input.float(25, "ADX Threshold (Trending)", minval=10, maxval=50, step=1, group=grpRegime,
     tooltip="ADX > threshold = Trending, ADX < threshold = Sideways")

// Trend Detection Method
trendMethod = input.string("EMA Crossover", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå", 
     options=["EMA Crossover", "ADX DI", "Price vs MA"], group=grpRegime)

// EMA for Trend Detection
fastEma = input.int(20, "Fast EMA", minval=1, group=grpRegime)
slowEma = input.int(50, "Slow EMA", minval=1, group=grpRegime)

// Sideways Detection
sidewaysMultiplier = input.float(1.5, "Sideways Detection Multiplier", minval=1, maxval=3, step=0.1, group=grpRegime,
     tooltip="‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á = ‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ Sideways")

// Visual Options
showRegimeLabel = input.bool(true, "‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î", group=grpRegime)
showRegimeBackground = input.bool(true, "‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î", group=grpRegime)

// === Calculate ADX ===
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)

// === Calculate EMAs ===
emaFast = ta.ema(close, fastEma)
emaSlow = ta.ema(close, slowEma)

// === Determine Market Regime ===
// 1. Check if market is Trending or Sideways (using ADX)
isTrending = adx > adxThreshold
isSideways = adx <= adxThreshold

// 2. Determine Trend Direction
var string marketRegime = "SIDEWAYS"

if useRegimeDetection
    if isTrending
        if trendMethod == "EMA Crossover"
            marketRegime := emaFast > emaSlow ? "UPTREND" : "DOWNTREND"
        else if trendMethod == "ADX DI"
            marketRegime := diPlus > diMinus ? "UPTREND" : "DOWNTREND"
        else if trendMethod == "Price vs MA"
            marketRegime := close > emaSlow ? "UPTREND" : "DOWNTREND"
    else
        marketRegime := "SIDEWAYS"
else
    marketRegime := "NORMAL"  // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö

// === Visual Indicators ===
// Background Color
bgColor = showRegimeBackground ? 
     (marketRegime == "UPTREND" ? color.new(color.green, 95) : 
      marketRegime == "DOWNTREND" ? color.new(color.red, 95) : 
      marketRegime == "SIDEWAYS" ? color.new(color.yellow, 95) : na) : na
bgcolor(bgColor)

// Regime Label
if showRegimeLabel and barstate.islast
    regimeText = marketRegime + "\nADX: " + str.tostring(adx, "#.#")
    regimeColor = marketRegime == "UPTREND" ? color.green : 
                  marketRegime == "DOWNTREND" ? color.red : 
                  color.orange
    label.new(bar_index, high, regimeText, 
         style=label.style_label_left, 
         color=regimeColor, 
         textcolor=color.white, 
         size=size.large)

// Plot EMAs for reference
plot(useRegimeDetection ? emaFast : na, "Fast EMA", color=color.new(color.blue, 50), linewidth=1)
plot(useRegimeDetection ? emaSlow : na, "Slow EMA", color=color.new(color.orange, 50), linewidth=2)

// =====================================================================================================
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ADAPTIVE STRATEGY PARAMETERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================================================
grpAdaptive = "Adaptive Parameters"
useAdaptiveParams = input.bool(true, "‡πÉ‡∏ä‡πâ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß", group=grpAdaptive,
     tooltip="‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Key Value ‡πÅ‡∏•‡∏∞ ATR Period ‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î")

// Parameters for Each Regime
// TRENDING (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡∏Å‡∏ß‡πà‡∏≤ ‡∏à‡∏±‡∏ö‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß)
trendingKeyValue = input.float(3.0, "Key Value (Trending)", step=0.25, group=grpAdaptive)
trendingAtrPeriod = input.int(10, "ATR Period (Trending)", minval=1, group=grpAdaptive)

// SIDEWAYS (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏£‡∏ö‡∏Å‡∏ß‡∏ô)
sidewaysKeyValue = input.float(4.0, "Key Value (Sideways)", step=0.25, group=grpAdaptive)
sidewaysAtrPeriod = input.int(14, "ATR Period (Sideways)", minval=1, group=grpAdaptive)

// Trading Rules per Regime
tradeTrending = input.bool(true, "‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏ß‡∏∞ Trending", group=grpAdaptive)
tradeSideways = input.bool(false, "‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏ß‡∏∞ Sideways", group=grpAdaptive,
     tooltip="‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏° ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Sideways ‡∏°‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡πá‡∏à")

// === Apply Adaptive Parameters ===
a = useAdaptiveParams ? 
     (marketRegime == "SIDEWAYS" ? sidewaysKeyValue : trendingKeyValue) : 
     input.float(3.25, title="Key Value (Manual)", step=0.25)

// Manual ATR Period (when adaptive is OFF)
manualAtrPeriod = input.int(10, title="ATR Period (Manual)")

// ‚ö†Ô∏è FIX: Calculate ATR for each period separately (Pine v5 requires simple int)
xATR_trending = ta.atr(trendingAtrPeriod)
xATR_sideways = ta.atr(sidewaysAtrPeriod)
xATR_manual = ta.atr(manualAtrPeriod)

// Select the appropriate ATR based on current regime
xATR_selected = useAdaptiveParams ? 
     (marketRegime == "SIDEWAYS" ? xATR_sideways : xATR_trending) : 
     xATR_manual

// ====== Check if trading is allowed in current regime ======
allowTrade = (marketRegime == "UPTREND" or marketRegime == "DOWNTREND") ? tradeTrending : 
             (marketRegime == "SIDEWAYS" ? tradeSideways : true)

// -------- Filters: Date Range --------
usefromDate = input.bool(defval=true,  title='From', inline="From Date", group="Filters")
fromDate    = input.time(defval=timestamp('01 Jan 2025 00:00 UTC'), title='', inline="From Date", group='Filters')
usetoDate   = input.bool(defval=false, title='To ', inline="To Date",  group="Filters")
toDate      = input.time(defval=timestamp('31 Dec 2025 23:59 UTC'),   title='', inline="To Date",  group="Filters")

inRange = (usefromDate ? time >= fromDate : true) and (usetoDate ? time <= toDate : true)

// -------- Other Inputs --------
h = input.bool(false, title="Signals from Heikin Ashi Candles", group="Core Settings")

// -------- TP / SL (separate toggles) --------
groupTPSL = "Take Profit / Stop Loss"
useTP = input.bool(false,  "Use TP", inline="TP", group=groupTPSL)
tpPct = input.float(2.0,  "TP %",   inline="TP", group=groupTPSL, step=0.1, minval=0)/100.0

useSL = input.bool(false,  "Use SL", inline="SL", group=groupTPSL)
slPct = input.float(1.0,  "SL %",   inline="SL", group=groupTPSL, step=0.1, minval=0)/100.0

// ======== TRAILING STOP (‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≥‡πÑ‡∏£) ========
groupTrailing = "Trailing Stop (Lock Profit)"
useTrailingLong = input.bool(false, "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Trailing Stop ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Long", group=groupTrailing, 
     tooltip="‡∏õ‡∏¥‡∏î Long ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î")
trailingPctLong = input.float(1.5, "Trailing Stop % (Long)", group=groupTrailing, step=0.1, minval=0.1) / 100.0
trailingActivationLong = input.float(0.5, "‡πÄ‡∏£‡∏¥‡πà‡∏° Trailing ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡πÑ‡∏£ % (Long)", group=groupTrailing, step=0.1, minval=0) / 100.0

useTrailingShort = input.bool(false, "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Trailing Stop ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Short", group=groupTrailing,
     tooltip="‡∏õ‡∏¥‡∏î Short ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏¥‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î")
trailingPctShort = input.float(1.5, "Trailing Stop % (Short)", group=groupTrailing, step=0.1, minval=0.1) / 100.0
trailingActivationShort = input.float(0.5, "‡πÄ‡∏£‡∏¥‡πà‡∏° Trailing ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡πÑ‡∏£ % (Short)", group=groupTrailing, step=0.1, minval=0) / 100.0

showTrailingLines = input.bool(true, "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô Trailing Stop ‡∏ö‡∏ô‡∏ä‡∏≤‡∏£‡πå‡∏ï", group=groupTrailing)

// === Money Management ===
initial_capital        = input.float(15,     title = "Initial Capital (USDT)", minval = 1,   group = "Money Management")
qty_per_trade          = input.float(10,     title = "Quantity Per Trade (USDT)", minval = 0.1, group = "Money Management")
use_percentage         = input.bool(false,   title = "Use % of Equity", group = "Money Management")
percentage_per_trade   = input.float(66.67,  title = "Percentage Per Trade (%)", minval = 1, maxval = 100, group = "Money Management")

// === Position Size ===
position_size = use_percentage ? (strategy.equity * percentage_per_trade / 100) / close : qty_per_trade / close

// =====================================================================================================
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CORE TRADING LOGIC (ATR Trailing Stop) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================================================

// -------- Core Logic --------
xATR  = xATR_selected  // ‡πÉ‡∏ä‡πâ ATR ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
nLoss = a * xATR

src = h ? request.security(ticker.heikinashi(syminfo.tickerid), timeframe.period, close, lookahead=barmerge.lookahead_off) : close

var float xATRTrailingStop = na
iff_1 = src > nz(xATRTrailingStop[1], 0) ? src - nLoss : src + nLoss
iff_2 = src < nz(xATRTrailingStop[1], 0) and src[1] < nz(xATRTrailingStop[1], 0) ? math.min(nz(xATRTrailingStop[1]), src + nLoss) : iff_1
xATRTrailingStop := src > nz(xATRTrailingStop[1], 0) and src[1] > nz(xATRTrailingStop[1], 0) ? math.max(nz(xATRTrailingStop[1]), src - nLoss) : iff_2

pos = 0
iff_3 = src[1] > nz(xATRTrailingStop[1], 0) and src < nz(xATRTrailingStop[1], 0) ? -1 : nz(pos[1], 0)
pos := src[1] < nz(xATRTrailingStop[1], 0) and src > nz(xATRTrailingStop[1], 0) ? 1 : iff_3

ema   = ta.ema(src, 1)
above = ta.crossover(ema, xATRTrailingStop)
below = ta.crossover(xATRTrailingStop, ema)

buy  = src > xATRTrailingStop and above
sell = src < xATRTrailingStop and below

barbuy  = src > xATRTrailingStop
barsell = src < xATRTrailingStop

// ===== ATR Trend Line (GREEN up / RED down) =====
atrTrendColor = src >= xATRTrailingStop ? color.new(color.lime, 0) : color.new(color.red, 0)
plot(xATRTrailingStop, title='ATR Trend', color=atrTrendColor, linewidth=2)

// -------- Plots (signals & bars) --------
plotshape(buy and allowTrade,  title='Buy',  text='Buy',  style=shape.labelup,   location=location.belowbar, color=color.new(color.green, 0), textcolor=color.white, size=size.tiny)
plotshape(sell and allowTrade, title='Sell', text='Sell', style=shape.labeldown, location=location.abovebar, color=color.new(color.red,   0), textcolor=color.white, size=size.tiny)
barcolor(barbuy ? color.new(color.green, 0) : barsell ? color.new(color.red, 0) : na)

// -------- Entries (respect date filter AND regime filter) --------
if inRange and buy and allowTrade
    strategy.entry('Long', strategy.long,  qty = position_size)
if inRange and sell and allowTrade
    strategy.entry('Short', strategy.short,  qty = position_size)

// ======== TRAILING STOP LOGIC ========
var float longHighest = na
var float shortLowest = na

// Long Position
if strategy.position_size > 0
    activationPrice = strategy.position_avg_price * (1 + trailingActivationLong)
    if high >= activationPrice
        longHighest := na(longHighest) ? high : math.max(longHighest, high)
    shortLowest := na
    
// Short Position    
else if strategy.position_size < 0
    activationPrice = strategy.position_avg_price * (1 - trailingActivationShort)
    if low <= activationPrice
        shortLowest := na(shortLowest) ? low : math.min(shortLowest, low)
    longHighest := na
    
// No Position
else
    longHighest := na
    shortLowest := na

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Trailing Stop Level
longTrailingStop = not na(longHighest) ? longHighest * (1 - trailingPctLong) : na
shortTrailingStop = not na(shortLowest) ? shortLowest * (1 + trailingPctShort) : na

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Trailing Stop ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
if not na(longTrailingStop) and longTrailingStop <= strategy.position_avg_price
    longTrailingStop := na
if not na(shortTrailingStop) and shortTrailingStop >= strategy.position_avg_price
    shortTrailingStop := na

// ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Trailing Stop Hit
longTrailingHit = strategy.position_size > 0 and useTrailingLong and not na(longTrailingStop) and close < longTrailingStop
shortTrailingHit = strategy.position_size < 0 and useTrailingShort and not na(shortTrailingStop) and close > shortTrailingStop

// ‡∏õ‡∏¥‡∏î Position ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ Trailing Stop
if longTrailingHit
    strategy.close("Long", comment="Trailing Stop Long")
if shortTrailingHit
    strategy.close("Short", comment="Trailing Stop Short")

// Plot Trailing Stop Lines
plot(showTrailingLines and strategy.position_size > 0 and useTrailingLong ? longTrailingStop : na, 
     "Long Trailing Stop", color=color.new(color.orange, 30), linewidth=2, style=plot.style_linebr)
plot(showTrailingLines and strategy.position_size < 0 and useTrailingShort ? shortTrailingStop : na, 
     "Short Trailing Stop", color=color.new(color.orange, 30), linewidth=2, style=plot.style_linebr)

// -------- TP/SL Calculation --------
longTP  = strategy.position_size > 0 and useTP ? strategy.position_avg_price * (1 + tpPct) : na
longSL  = strategy.position_size > 0 and useSL ? strategy.position_avg_price * (1 - slPct) : na
shortTP = strategy.position_size < 0 and useTP ? strategy.position_avg_price * (1 - tpPct) : na
shortSL = strategy.position_size < 0 and useSL ? strategy.position_avg_price * (1 + slPct) : na

// -------- ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö TP/SL Hits (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) --------
longTPHit  = not na(longTP) and high >= longTP
longSLHit  = not na(longSL) and low <= longSL
shortTPHit = not na(shortTP) and low <= shortTP
shortSLHit = not na(shortSL) and high >= shortSL

// -------- Exits: ‡πÉ‡∏´‡πâ Strategy ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° Webhook Signals --------
// ‡∏õ‡∏¥‡∏î Long Position
if strategy.position_size > 0
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ TP
    if useTP and longTPHit
        strategy.close("Long", comment="TP Hit")
        label.new(bar_index, high, "üéØ TP Hit", style=label.style_label_down, color=color.new(color.green, 0), textcolor=color.white, size=size.small)
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ SL
    else if useSL and longSLHit
        strategy.close("Long", comment="SL Hit")
        label.new(bar_index, low, "üõë SL Hit", style=label.style_label_up, color=color.new(color.red, 0), textcolor=color.white, size=size.small)

// ‡∏õ‡∏¥‡∏î Short Position  
if strategy.position_size < 0
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ TP
    if useTP and shortTPHit
        strategy.close("Short", comment="TP Hit")
        label.new(bar_index, low, "üéØ TP Hit", style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.small)
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ SL
    else if useSL and shortSLHit
        strategy.close("Short", comment="SL Hit")
        label.new(bar_index, high, "üõë SL Hit", style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.small)

// -------- Plot TP/SL Lines --------
plot(useTP ? longTP  : na, 'Long TP',  color=color.new(color.lime, 40), style=plot.style_linebr)
plot(useSL ? longSL  : na, 'Long SL',  color=color.new(color.red,  40), style=plot.style_linebr)
plot(useTP ? shortTP : na, 'Short TP', color=color.new(color.lime, 40), style=plot.style_linebr)
plot(useSL ? shortSL : na, 'Short SL', color=color.new(color.red,  40), style=plot.style_linebr)

// =====================================================================================================
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Trading Bot Webhook (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Long/Short) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================================================
grpW = "Trading Bot Webhook"
useWH = input.bool(false, "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Webhook", group=grpW, 
     tooltip="‡∏ï‡∏±‡πâ‡∏á Alert = Any alert() function call ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà Webhook URL ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Trading Bot")

botId  = input.int(0, "Bot ID", group=grpW, tooltip="Bot ID ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Trading Bot")
botToken  = input.string("", "Bot Token", group=grpW, tooltip="Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô")

autoCloseOnTP = input.bool(false, "Auto CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ TP", group=grpW)
autoCloseOnSL = input.bool(false, "Auto CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ SL", group=grpW)
autoCloseOnTrailing = input.bool(true, "Auto CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ Trailing Stop", group=grpW)

showWebhookSignals = input.bool(true, "‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Webhook ‡∏ö‡∏ô‡∏ä‡∏≤‡∏£‡πå‡∏ï", group=grpW)

// JSON helpers
json_signal(action, pair, price, token) =>
    '{ "action":"' + action + '", "pair":"' + pair + '", "price":"' + str.tostring(price) + '", "token":"' + token + '" }'

whReady() =>
    useWH and botId > 0 and str.length(botToken) > 0

// State tracking ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡πâ‡∏≥
var string lastSignal = ""
var int lastSignalBar = 0

// Reset lastSignal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ position (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î position ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ)
if strategy.position_size == 0 and lastSignal != ""
    lastSignal := ""

// Get current symbol
currentPair = str.replace(str.replace(syminfo.tickerid, "BINANCE:", ""), ".P", "")

// Fire webhook alerts
if barstate.isconfirmed and whReady()
    
    // ‚≠ê ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ Trailing Stop (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å)
    if autoCloseOnTrailing and (longTrailingHit or shortTrailingHit)
        if lastSignal != "CLOSE_TRAIL" or bar_index != lastSignalBar
            alert(json_signal("CLOSE", currentPair, "market", botToken), alert.freq_once_per_bar_close)
            lastSignal := "CLOSE_TRAIL"
            lastSignalBar := bar_index
            if showWebhookSignals
                trailLabel = longTrailingHit ? "üî∏ Trail CLOSE Long" : "üî∏ Trail CLOSE Short"
                labelY = longTrailingHit ? high : low
                labelStyle = longTrailingHit ? label.style_label_down : label.style_label_up
                label.new(bar_index, labelY, trailLabel, style=labelStyle, color=color.orange, textcolor=color.white, size=size.small)
    
    // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ TP
    else if autoCloseOnTP and (longTPHit or shortTPHit)
        if lastSignal != "CLOSE_TP" or bar_index != lastSignalBar
            alert(json_signal("CLOSE", currentPair, "market", botToken), alert.freq_once_per_bar_close)
            lastSignal := "CLOSE_TP"
            lastSignalBar := bar_index
            if showWebhookSignals
                label.new(bar_index, high, "üéØ TP CLOSE", style=label.style_label_down, color=color.orange, textcolor=color.white, size=size.small)

    // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì CLOSE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ SL  
    else if autoCloseOnSL and (longSLHit or shortSLHit)
        if lastSignal != "CLOSE_SL" or bar_index != lastSignalBar
            alert(json_signal("CLOSE", currentPair, "market", botToken), alert.freq_once_per_bar_close)
            lastSignal := "CLOSE_SL"
            lastSignalBar := bar_index
            if showWebhookSignals
                label.new(bar_index, low, "üõë SL CLOSE", style=label.style_label_up, color=color.red, textcolor=color.white, size=size.small)

    // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì BUY/LONG (‡πÄ‡∏ä‡πá‡∏Ñ allowTrade ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ regime detection)
    else if buy and inRange and allowTrade
        if lastSignal != "BUY" or bar_index != lastSignalBar
            alert(json_signal("BUY", currentPair, "market", botToken), alert.freq_once_per_bar_close)
            lastSignal := "BUY"
            lastSignalBar := bar_index
            if showWebhookSignals
                label.new(bar_index, low, "üìà BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

    // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì SELL/SHORT (‡πÄ‡∏ä‡πá‡∏Ñ allowTrade ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ regime detection)
    else if sell and inRange and allowTrade
        if lastSignal != "SELL" or bar_index != lastSignalBar
            alert(json_signal("SELL", currentPair, "market", botToken), alert.freq_once_per_bar_close)
            lastSignal := "SELL"
            lastSignalBar := bar_index
            if showWebhookSignals
                label.new(bar_index, high, "üìâ SELL", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// Alert conditions
alertcondition(buy and inRange and allowTrade,  title="Buy Signal",  message="BUY")
alertcondition(sell and inRange and allowTrade, title="Sell Signal", message="SELL")
alertcondition(longTrailingHit or shortTrailingHit, title="Trailing Stop Hit", message="Trailing Stop Hit")
